University: ITMO University

Faculty: FICT

Course: Network programming

Year: 2022/2023

Group: K34212

Author: Ekaterina Telegina

Lab: Lab 4

Date created:

Date finished:

ЦЕЛЬ РАБОТЫ

Изучить синтаксис языка программирования P4 и выполнить 2 задания обучающих задания от Open network foundation для ознакомления на практике с P4.

ХОД РАБОТЫ

1. Basic Forwarding

Перед выполнением задания с помощью Vagrant была установлена виртуальная машина, на которой имеются все необходимые программы. 
Подключить к машине под учетной записи p4 и заходить в папку с упраженениями.

![image](https://user-images.githubusercontent.com/53398280/207095078-e153ee0f-f055-4d4d-86bb-a24aaf0443d2.png)

Цель данного упражнения — написать программу P4, реализующую базовую переадресацию для ipv4. Идея задачи в том, 
что коммутатор должен выполнять следующие действия для каждого пакета: обновлять MAC-адреса источника и получателя, 
уменьшать время жизни (TTL) в заголовке IP и пересылать пакет на соответствующий порт.

В начале конфигурация в файле basic.p4 отбрасывает все пакеты. Задача закючается в расширении программы для правильной пересылки пакетов.

Схема связи представлена ниже.

![image](https://user-images.githubusercontent.com/53398280/207095172-1a6dfcac-55ad-4841-a2d4-e6ce243cd67f.png)


Запустить первичный код

Скомпилировать файл basic.p4 и включить переключатель в Mininet с помощью команды make run, чтобы проверить его поведение. 
После этого мы должны увидеть командную строку Mininet.

![image](https://user-images.githubusercontent.com/53398280/207095224-4fd6849f-53ad-4d7b-8f88-2ee835f30705.png)


Попробовать пинг между хостами в схеме. Пинг не удался потому что коммутаторы запрограмированы в соответствии с файлом basic.p4, 
который отбрасывает все пакет по умолчанию.

![image](https://user-images.githubusercontent.com/53398280/207095282-e414d22f-668f-4ba6-a82e-7b1cc179de87.png)

Вытий из командной строки Mininet и остановить Mininet.

![image](https://user-images.githubusercontent.com/53398280/207095543-9db81d1e-69c9-453e-a4e7-0cfc2bdbbe7a.png)

Реализовать пересылки пакетов

Добавлены парсер parse_ethernet, извелкающий Ethernet заголовок и парсер parse_ipv4, извлекающий IPv4 заголовок из пакета.

При извлечении Ethernet заголовка, если значение поля etherType равно 0x800 то следует извлекать внутренний IPv4 заголовок.

![image](https://user-images.githubusercontent.com/53398280/207095946-02baf533-8af0-4e5b-b278-5fce40d26dd3.png)


После извлечения заголовков нужно обратиться к таблице маршрутов для того, чтобы определить на какой порт пересылать пакет. 

Это действие выполняется функцией MyIngress.


Добавлена логика пересылки пакетов, которая:

определяет выходной порт

обновляет Ethernet адрес назначения

обновляет Ethernet адрес источника

уменьшает TTL

![image](https://user-images.githubusercontent.com/53398280/207096095-e1c7b408-35ef-444f-af84-f12e714e9ce3.png)


Определена таблица, которая читает адрес назначения и вызывает соответственно действие.

![image](https://user-images.githubusercontent.com/53398280/207096201-a52a8ca4-dab4-4bb7-8c49-72b91475cccd.png)

Применить таблицу, если заголовок ipv4 правильный.

![image](https://user-images.githubusercontent.com/53398280/207096279-1e9a37b1-421e-4399-9717-fd97bf5ce2c9.png)


Добавлен депарсер для вставки заголовков в исходящий пакет.

![image](https://user-images.githubusercontent.com/53398280/207096355-02b41dce-f1da-4cff-89c2-dfaad4e8c73a.png)

Запустить решение

Запустить Mininet и пробовать пинг между хостами.

![image](https://user-images.githubusercontent.com/53398280/207096727-2dd5f144-2678-4216-96fd-eff4230c660a.png)


2. Basic Tunneling

Цель данного задания - добавить поддержку базового протокола туннелирования на основе предыдущего задания. 
Определить новый тип заголовка для инкапсуляции IP-пакета и изменить код программы, 
чтобы она могла определить порт назначения, используя новый заголовок туннеля.

Схема связи представлена ниже. 

![image](https://user-images.githubusercontent.com/53398280/207096808-ac361aeb-df2f-4b58-af52-6b4c6ea2e12a.png)


Перейти на папку второго задания.

![image](https://user-images.githubusercontent.com/53398280/207096843-e6a3c284-3b49-44f1-9962-1ee83fb47c69.png)

Реализовать туннелирование
Файл basic_tunnel.p4 является решением предыдущего задания. Полная реализация файла basic_tunnel.p4 сможет 
выполнять пересылку на основе содержимого пользовательского заголовка инкапсуляции, а также выполнять обычную IP-пересылку, 
если заголовок инкапсуляции не существует в пакете.

Добавлен новый тип заголовка myTunnel_t, который содержит два 16-битных поля: proto_id и dst_id.

![image](https://user-images.githubusercontent.com/53398280/207097028-3a63b84e-de3f-4307-8017-63cc9ec83b0c.png)

![image](https://user-images.githubusercontent.com/53398280/207097084-51ad3c94-ee30-4daf-8fee-ad14670c51cb.png)


Обновлен парсер чтобы извлечь либо заголовок myTunnel, либо заголовок ipv4 в зависимости от значения поля etherType в заголовке Ethernet. etherType, 
соответствующий заголовку myTunnel, равен 0x1212. Парсер также должен извлекать заголовок ipv4 после заголовка myTunnel, если proto_id == 0x800.

![image](https://user-images.githubusercontent.com/53398280/207097171-cb61c4b0-4088-40ae-90c3-88851bacc77f.png)


Создана новая таблица myTunnel_exact, которая вызывает функцию myTunnel_forward при совпадении значения поля dst_id.

![image](https://user-images.githubusercontent.com/53398280/207099373-c2c33579-d8a4-43cf-98dd-c6938c87e957.png)


Добавлена фукнция myTunnel_forward, которая обновляет выходной порт для пакета.

![image](https://user-images.githubusercontent.com/53398280/207099463-ffe4de51-a08e-4d3e-8e68-ccc95dbd95f9.png)


Обновлена функция apply(), чтобы она могла вызывать либо таблицу myTunnel_exact, либо таблицу ipv4_lpm при необходимости.
![image](https://user-images.githubusercontent.com/53398280/207099537-9f70d420-fcc3-4489-b903-4485418f799f.png)


Обновлен депарсер.
![image](https://user-images.githubusercontent.com/53398280/207099615-4f7e0bbd-dc88-4707-b5ca-b6fc29fc6c9f.png)

Таблица myTunnel_exact еще не заполнена. Заполнить таблицу на основе схеме связи, редактировав файл s1-runtime.json, s2-runtime.json, s3-runtime.json
![image](https://user-images.githubusercontent.com/53398280/207099673-c0ad0263-de6d-49b5-a7f6-9a8cacc3d1e2.png)


Запустить решение
Запустить Mininet.

Открыть 2 терминала для хостов h1 и h2.
![image](https://user-images.githubusercontent.com/53398280/207099772-7bcd8a63-9d91-46dd-9fc3-02e00e5c46b8.png)


Запустить сервер на хосте h2.
![image](https://user-images.githubusercontent.com/53398280/207099828-0ae7a246-44ce-4a6b-8d7c-c92cb587268c.png)


На хосте h1 отправлять хосту h2 пакет без туннелирования, указав ip адрес хоста h2.
![image](https://user-images.githubusercontent.com/53398280/207099879-ce8b5d9d-f0f8-4538-8210-87cb8378800a.png)

При этом пакет состоит из заголовка Ethernet, заголовка IP, заголовка TCP и сообщения "hello h2 no tunneling".

Теперь на хосте h1 отправлять хосту h2 туннелированный пакет. В этом случае IP адрес не важен, важен только id назначения. 
Коммутатор больше не использует заголовок IP для маршрутизации, когда заголовок MyTunnel находится в пакете.
![image](https://user-images.githubusercontent.com/53398280/207099983-a3838a6f-5eae-4103-9dcc-db3dcf7b6a0f.png)

Теперь на хосте h1 отправлять хосту h2 туннелированный пакет. В этом случае IP адрес не важен, важен только id назначения. Коммутатор больше не использует заголовок IP для маршрутизации, когда заголовок MyTunnel находится в пакете.

ВЫВОД
В ходе выполнения лабораторной работы была создана виртуальная машина для работы с P4. После чего был зучен синтаксис языка программирования P4 и выполнены 2 задания обучающих задания.
